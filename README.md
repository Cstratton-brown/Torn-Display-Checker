# Torn-Display-Checker
Code written in Javascript intended to be used as a google Apps Script addition to a spreadsheet for the tracking of flowers, plushies and artifacts for the text based MMO Torn. The main intedned use for this is to track and record the contribution of multiple users in preperation for the yearly Museum Day Event. The code is designed based on a max group of 20 although this amount can be extended easily both on the spreadsheet and the within the code. The spreadsheet also includes a page for the distribution of points designed in such a way that everyone gets at a minimum the amount of points from the sets of flowers, plushies and artifcats that they have contributed, any leftover sets made up from all the leftover items are then distributed equally between all participants,

## checkDisplay.GS
This is the core functionality of the code and contains the core functionality that are used to update the spreadsheet and send results to discord.

### generateUserReference()
This function creates an array of objects and then fills it with the data found within the userReference pag on the spreadsheet. It grabs the range of the entire page, which has been limited to only collumns and rows containing needed data, and then gets the values from within there. It then uses a For Loop to itterate each row of data as a new object into the Array using the first row of headers as the properties.

### emptySpreadsheet()
This function is simple but important as all it does is prefill the tables with 0 values. This is needed as without the 0 values the formulas used on each page to tally up sets and lowest amounts will detect a null value and break as a result. This runs att the start each time incase a user removes items from their display case so that a previous amount is left displayed when in there is in fact 0 of that item within the users display case

### tallyChanges()
This is the last function to run every time the spreadsheet is updated as it tallies all the changes and sends them through a discord webhook url to post an update on the number of sets, the total points earned and the whichever flower and plushie has the lowest amount. It retrieves the total points earned and the total number of sets straight from the spreadsheet cells containing those values to include in the discord message. For the plushies and flowers it gets an array of the totals row for each page and then proceeds to go through each array and returns the index in each array which contains the lowest value, these indexes are then sent to switch statements to return the flower and plushie type that corresponds to that specific index which is then added to the discord message. after all this is done the finalized discord message is sent via a supplied discord webhook url to the channel the user chooses.

### updateMarketValue()
Updates the market value of all items listed in item_reference.json.html. Makes and API call to torn to return the details of all items and then iterates through the items listed in item_reference.json.html, when it finds an item that has a matching unique ID it then returns the market value of that item supplied by ther API call and inserts it into the appropriate are of the spreadsheet. This repeats for all items listed in item_reference.json.html

### checkDisplays()
checkDisplays() is the main function of this script as it iterates through a list of user IDs that have been supplied and returns the contents of the users display case if they have one, if a user has no display case it simply proceeds to the next person in the list. Before anything else it calls emptySpreadsheet() to prefill the tables with 0's. Next it calls updatedMarketValue to update all the items market value to provide an accurate representation of the value of the contributions. Finally it calls generateUserReference() to grab the data in the userReference page of the spreadsheet and returns a list of objects containing the users. Once this is done an API call is made to retrieve the contents of the display case belonging to the first userID in the list of onjects returned by generateUserReference(). After retrieving the contents of the users display case it then itterates through a provided list of items to check the display case for, if a matching item is found its amount is then inserted into the sheet using row and collumn properties for each user and item provided in generateUserReference(), the row property of each userID, and the item_references respectively. After all the items within a display case has been checked it then proceeds onto the next userID returned by generateUserReference(). After it has gone through all the listed users it calls tallyChanges() which then grabs the values which may or may not have changed after the spreadsheets update and sends them to Discord.

## item_reference.json.html
This is an HTML file that then gets parsed to json when it is called in updateMarketValue(), and checkDisplays(). It contains a list of all items to check based of their Name. Each item has additional properties that are used in checkDisplays() and updateMarketValue() such as type, if it is a flower, plushie or artifact, its unique ID, a shortened version of its name and its collumn value. The type property is used to determine which page of the spreadsheet the items quantity or market value need to be inserted into, Flowers, Plushies and Artifacts respectively. The Collumn value is the collumn that all values for this item are to be inserted into.

# Spreadsheet
This is a copy of the google sheets spreadsheets that is formatted to work with this script. It contains 4 main pages Flowers, Plushies, Artifacts and Maths. All new contributers to the sets must be added in the Maths page of the spreadsheet and from there the other pages will auto copy the value into the appropriate cell.

## Flowers
This page tracks all the flowers each user adds to their display case and includes a count of each users individual number of sets as well as a total sets for all users including sets made up of the excess from the individual users. It also tracks the total number of trips each person made and the total market value of each flower type as well as overall.

## Plushies
This page tracks all the plushies each user adds to their display case and includes a count of each users individual number of sets as well as a total sets for all users including sets made up of the excess from the individual users. It also tracks the total number of trips each person made and the total market value of each flower type as well as overall.

## Artifacts
This page tracks all the Artifacts each user adds to their display case and includes a count of each users individual number of sets as well as a total sets for all users including sets made up of the excess from the individual users. It also tracks the total number of trips each person made and the total market value of each flower type as well as overall. As Artifacts contains 3 types of sets as well as 4 items that can be exchanged alone for points the layout and total set numbers and their rules are slightly different from the previous 2 pages. The main example is that a senet board set requires 1 board and 5 of each senet pieces.

## Maths
This Page contains all the Maths for the distribution of the the points, including the market value of each users contribution, the % of sets they contributed, the amount of points that earnes the user and the number of excess points from leftover flowers and plushies making sets, this currently doesnt include artifacts. This page also includes the total number of points from exchanging sets, the total points from sets contributed, the points earned from leftover sets, the number of participants and the shares of the excess points each participant is entitled to
